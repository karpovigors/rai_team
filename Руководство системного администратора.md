# Руководство системного администратора

## 1. Назначение системы

Система представляет собой веб-платформу навигации и информирования пользователей (в т.ч. с ограничениями по слуху) с фронтендом на React/Vite и бэкендом на Django REST API.

Основные подсистемы:
- веб-клиент (Nginx + собранный SPA);
- API-сервер (Django);
- СУБД PostgreSQL;
- S3-совместимое хранилище MinIO для медиа;
- инициализатор бакета MinIO.

## 2. Архитектура и сервисы

Оркестрация выполняется через Docker Compose.

Состав контейнеров:
- `db` — PostgreSQL (порт хоста `5433` → контейнер `5432`);
- `backend` — Django API (внутренний `8000`);
- `frontend` — Nginx со статикой фронтенда (порт хоста `80`);
- `s3` — MinIO (порты `9000` API и `9001` Console);
- `s3-init` — одноразовая инициализация бакета.

Проксирование запросов с фронтенда к API и медиа настроено в `client/nginx.conf`.

## 3. Системные требования

Минимально:
- Docker Engine с поддержкой Compose v2;
- GNU Make;
- свободные порты: `80`, `5433`, `9000`, `9001`.

Для локальной разработки без Docker:
- Python 3.12+ и pip;
- Node.js 20+ и npm.

## 4. Переменные окружения

Базовый шаблон: `.env.example`.

Критичные группы переменных:

1) База данных
- `DB_NAME`
- `DB_USER`
- `DB_PASSWORD`
- `DB_HOST`
- `DB_PORT`

2) Django
- `DEBUG`
- `SECRET_KEY`
- `DJANGO_SUPERUSER_USERNAME`
- `DJANGO_SUPERUSER_PASSWORD`
- `DJANGO_SUPERUSER_EMAIL`
- `MODERATOR_USERNAME`
- `MODERATOR_PASSWORD`
- `MODERATOR_EMAIL`

3) S3 / MinIO
- `S3_ACCESS_KEY`
- `S3_SECRET_KEY`
- `S3_BUCKET_NAME`
- `S3_ENDPOINT_URL`

4) Push-уведомления
- `VAPID_PUBLIC_KEY`
- `VAPID_PRIVATE_KEY`
- `VAPID_SUBJECT`

5) Карты/геокодер
- `VITE_YANDEX_GEOCODER_API_KEY`
- `VITE_YANDEX_MAPS_API_KEY` (если используется в клиентском коде)

Примечание: в Compose для бэкенда используется подстановка `YANDEX_GEOCODER_API_KEY` из `VITE_YANDEX_GEOCODER_API_KEY`.

## 5. Подготовка и запуск (Docker)

1. Создать файл `.env` на основе шаблона.
2. Проверить значения секретов и паролей.
3. Запустить сборку и контейнеры:

```bash
make build
make up
```

Либо сразу в режиме с логами:

```bash
make dev
```

Список команд администрирования: `Makefile`.

## 6. Инициализация приложения при старте

При старте сервиса `backend` автоматически выполняются:
1. проверка миграций;
2. применение миграций;
3. создание/обновление bootstrap-пользователей;
4. заполнение тестовыми данными;
5. запуск Django-сервера.

Команды bootstrap:
- создание администратора и модератора: `bootstrap_users`;
- заполнение мок-данными: `seed_mock_data`.

## 7. Проверка работоспособности

Health-check endpoints:
- backend: `GET /health/`;
- frontend: `GET /health`.

Проверка контейнеров:

```bash
make ps
```

Просмотр логов:

```bash
make logs
make logs-backend
make logs-frontend
make logs-db
```

## 8. Доступы и роли

Автоматически создаются:
- суперпользователь Django Admin;
- пользователь-модератор (признак `is_moderator`).

Параметры задаются в `.env` через переменные `DJANGO_SUPERUSER_*` и `MODERATOR_*`.

Ограничение доступа к `/admin/`: только активный суперпользователь.

## 9. API (ключевые точки)

Ключевые группы:
- авторизация JWT: `/api/auth/*`;
- объекты и отзывы: `/api/objects*`;
- push: `/api/push/*`;
- служебный ping: `/api/ping`.

## 10. Резервное копирование и восстановление БД

Создание бэкапа:

```bash
make db-backup
```

Файл будет сохранен в каталог `./backups`.

Восстановление:

```bash
make db-restore FILE=backups/<имя_файла>.sql
```

## 11. Эксплуатационные операции

Остановка:

```bash
make down
```

Перезапуск:

```bash
make restart
```

Полная очистка окружения (включая volumes):

```bash
make clean
```

Быстрая пересборка:

```bash
make rebuild
```

Полная пересборка без кэша:

```bash
make rebuild-clean
```

## 12. Безопасность (минимальные требования для production)

Обязательно перед промышленной эксплуатацией:
1. `DEBUG=False`;
2. заменить `SECRET_KEY` на уникальный секрет;
3. ограничить `ALLOWED_HOSTS` и `CORS_ALLOWED_ORIGINS`;
4. сменить стандартные пароли БД/MinIO/администратора;
5. включить TLS на внешнем контуре;
6. ограничить доступ к MinIO Console (`9001`);
7. исключить автозаполнение тестовыми данными на production.

## 13. Локальный запуск без Docker (опционально)

Backend:

```bash
cd rai_project
pip install -r requirements.txt
python manage.py migrate
python manage.py runserver
```

Frontend:

```bash
cd client
npm install
npm run dev
```

## 14. Источники конфигурации

- `README.md`
- `docker-compose.yml`
- `Makefile`
- `.env.example`
- `rai_project/rai_project/settings.py`
- `rai_project/rai_project/urls.py`
- `rai_project/core/urls.py`
- `client/nginx.conf`
- `rai_project/Dockerfile`
- `client/Dockerfile`
- `rai_project/core/management/commands/bootstrap_users.py`
- `rai_project/core/management/commands/seed_mock_data.py`
